name: pre-commit

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  pre-commit:
    permissions:
      actions: write
    runs-on: ubuntu-24.04
    outputs:
      changed_dir: ${{ steps.get_changed_dirs.outputs.changed_dirs }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Setup Python 3.13
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6 # v6.6.1
        with:
          version: "0.8.15"
          enable-cache: true

      - name: Cache pre-commit dependencies
        id: cache_pre_commit
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        env:
          cache-name: cache-pre-commit
        with:
          path: ~/.cache/pre-commit
          key: ${{ env.cache-name }}-${{ hashFiles('.pre-commit-config.yaml', '~/.cache/pre-commit/*') }}

      - name: Install pre-commit
        if: steps.cache_pre_commit.outputs.cache-hit != 'true'
        run: |
          uv tool install pre-commit
          pre-commit install --install-hooks --hook-type pre-commit --hook-type commit-msg --hook-type pre-push
          pre-commit gc

      - name: Fetch remote branches
        run: >-
          git fetch --no-tags --prune --depth=1 origin
          +refs/heads/*:refs/remotes/origin/*

      - name: Get changed directories
        id: get_changed_dirs
        env:
          BASE_REF: ${{ github.base_ref }}
          SHA: ${{ github.sha }}
        run: |
          CHANGED_DIRS="$(git diff --name-only origin/"$BASE_REF" "$SHA" | awk -F/ '{print $1}' | sort -u)"
          export CHANGED_DIRS
          echo "Changed directories: \"$CHANGED_DIRS\""
          echo "changed_dirs=\"$CHANGED_DIRS\"" >> "$GITHUB_OUTPUT"

      - name: Check if only one directory was modified
        id: check_single_directory
        run: |
          if [ "$(echo "$changed_dirs" | wc -l)" -ne 1 ]; then
            echo "More than one directory was modified."
            exit 1
          fi
          echo "Only one directory was modified."

      # Only install if the directory is 'app', as it is the only directory that is expected to have a Dockerfile
      - name: Install hadolint
        if: success() && steps.check_single_directory.conclusion == 'success' && steps.get_changed_dirs.outputs.changed_dirs == 'app'
        run: >-
          curl -L "$(
          curl -s https://api.github.com/repos/hadolint/hadolint/releases/latest
          | grep -o -E -i -m 1 "https://.+?/hadolint-linux-x86_64"
          )"
          > hadolint
          && chmod +x hadolint && sudo mv hadolint /usr/bin/

      # Needed for re-running this workflow on the autofix commit.
      - name: Checkout again for pre-commit
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: ${{ github.sha }}
          token: ${{ secrets.TEST_HIVEBOX_AUTOFIX_COMMIT_KEY }}

      - name: Run pre-commit hooks
        env:
            BASE_REF: ${{ github.base_ref }}
            SHA: ${{ github.sha }}
        run: >-
          pre-commit run
          --from-ref origin/"$BASE_REF"
          --to-ref "$SHA"
          --color=always
          --show-diff-on-failure

      - name: Push fixes
        if: failure()
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5  # v9.1.4
        with:
          default_author: github_actions
          message: "[pre-commit] Autofix violations"

  app:
    needs: pre-commit
    uses: ./.github/workflows/app.yaml
    if: needs.pre-commit.outputs.changed_dir == 'app'
